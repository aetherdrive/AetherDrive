<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AetherDrive V3 Dashboard</title>
<style>
  body { font-family: Arial; padding: 2rem; background: #f0f2f5; color: #333; }
  h1 { color: #0077cc; }
  .card { background: #fff; padding: 1rem 2rem; margin: 1rem 0; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
</style>
</head>
<body>
<h1>AetherDrive V3 Dashboard</h1>

<div class="card"><strong>Status:</strong> <span id="status">Laster...</span></div>
<div class="card"><strong>Antall brukere:</strong> <span id="users">0</span></div>
<div class="card"><strong>Månedlig inntekt:</strong> <span id="revenue">0 NOK</span></div>
<div class="card">
  <strong>Ansatte og lønn:</strong>
  <ul id="employee-salaries"></ul>
</div>
<div class="card">
  <strong>Import status:</strong>
  <div>Sist import: <span id="last-import">-</span></div>
  <div>Accepted: <span id="import-accepted">0</span></div>
  <div>Duplicates: <span id="import-duplicates">0</span></div>
  <div>Rejected: <span id="import-rejected">0</span></div>
</div>
<div class="card">
  <strong>Integration:</strong>
  <div>Endpoint: <span id="integration-endpoint">-</span></div>
  <div>Key: <span id="integration-key">-</span></div>
</div>

<script>
const elements = {
  status: document.getElementById('status'),
  users: document.getElementById('users'),
  revenue: document.getElementById('revenue'),
  employeeList: document.getElementById('employee-salaries'),
  lastImport: document.getElementById('last-import'),
  importAccepted: document.getElementById('import-accepted'),
  importDuplicates: document.getElementById('import-duplicates'),
  importRejected: document.getElementById('import-rejected'),
  integrationEndpoint: document.getElementById('integration-endpoint'),
  integrationKey: document.getElementById('integration-key')
};
let lastSnapshot = null;
let activeController = null;
const POLL_INTERVAL_MS = 10000;

function snapshotKey(data) {
  if (!data) return '';
  return JSON.stringify({
    status: data.status,
    users: data.users,
    revenue: data.revenue,
    currency: data.currency,
    employees: data.employees,
    importStatus: data.importStatus,
    integration: data.integration
  });
}

function renderMetrics(data) {
  const key = snapshotKey(data);
  if (key === lastSnapshot) return;
  lastSnapshot = key;

  elements.status.textContent = data.status || 'Live';
  elements.users.textContent = data.users || 0;
  const currency = data.currency || 'NOK';
  elements.revenue.textContent = Number.isFinite(data.revenue)
    ? `${data.revenue.toLocaleString()} ${currency}`
    : `0 ${currency}`;

  elements.employeeList.textContent = '';
  if (Array.isArray(data.employees)) {
    const fragment = document.createDocumentFragment();
    data.employees.forEach((emp) => {
      const li = document.createElement('li');
      li.textContent = `${emp.name}: ${emp.currentSalary.toLocaleString()} NOK`;
      fragment.appendChild(li);
    });
    elements.employeeList.appendChild(fragment);
  }

  if (data.importStatus) {
    elements.lastImport.textContent = data.importStatus.lastImportAt || '-';
    elements.importAccepted.textContent = data.importStatus.accepted ?? 0;
    elements.importDuplicates.textContent = data.importStatus.duplicates ?? 0;
    elements.importRejected.textContent = data.importStatus.rejected ?? 0;
  }

  if (data.integration) {
    elements.integrationEndpoint.textContent = data.integration.endpoint || '-';
    elements.integrationKey.textContent = data.integration.key || '-';
  }
}

const API_BASE_URL = 'https://aetherdrive.onrender.com';

function buildUrl(path) {
  return `${API_BASE_URL}${path}`;
}

async function fetchMetrics() {
  if (document.hidden) {
    scheduleNext();
    return;
  }
  if (activeController) {
    activeController.abort();
  }
  activeController = new AbortController();
  try {
    const res = await fetch(buildUrl('/api/metrics'), { signal: activeController.signal });
    if (!res.ok) {
      throw new Error(`Ugyldig svar: ${res.status}`);
    }
    const data = await res.json();
    renderMetrics(data);
  } catch (err) {
    if (err.name !== 'AbortError') {
      elements.status.textContent = 'Feil ved henting';
      console.error(err);
    }
  } finally {
    scheduleNext();
  }
}

function scheduleNext() {
  window.setTimeout(fetchMetrics, POLL_INTERVAL_MS);
}

fetchMetrics();
</script>
</body>
</html>